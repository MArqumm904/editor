<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Konva Perspective Edge Warp</title>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #container { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="container"></div>
  <script>
    const stage = new Konva.Stage({
      container: "container",
      width: window.innerWidth,
      height: window.innerHeight,
    });

    const layer = new Konva.Layer();
    stage.add(layer);

    const imageObj = new Image();
    imageObj.crossOrigin = "Anonymous"; // cross-origin issue fix
    imageObj.src = "logo.jpg"; // apni image ka path do

    imageObj.onload = () => {
      const width = 300;
      const height = 200;
      const startX = 100;
      const startY = 100;

      // Anchors ke default 4 points
      const anchors = {
        tl: { x: startX, y: startY },
        tr: { x: startX + width, y: startY },
        bl: { x: startX, y: startY + height },
        br: { x: startX + width, y: startY + height },
      };

      // Custom shape jisme image draw hogi
      const warpedImage = new Konva.Shape({
        sceneFunc: (ctx, shape) => {
          drawWarpedImage(ctx, imageObj, anchors);
          ctx.fillStrokeShape(shape);
        },
      });
      layer.add(warpedImage);

      // Anchors banaye (draggable red dots)
      for (let key in anchors) {
        const anchor = new Konva.Circle({
          x: anchors[key].x,
          y: anchors[key].y,
          radius: 6,
          fill: "red",
          draggable: true,
          name: key,
        });

        anchor.on("dragmove", () => {
          // Update sirf us anchor ki position
          anchors[key] = { x: anchor.x(), y: anchor.y() };
          console.log("Dragged:", key, anchors[key]);

          warpedImage.getLayer().batchDraw();
        });

        layer.add(anchor);
      }

      layer.draw();
    };

    // Draw function for warped image
    function drawWarpedImage(ctx, image, pts) {
      const p = [pts.tl, pts.tr, pts.br, pts.bl];

      ctx.save();
      ctx.beginPath();
      ctx.moveTo(p[0].x, p[0].y);
      ctx.lineTo(p[1].x, p[1].y);
      ctx.lineTo(p[2].x, p[2].y);
      ctx.lineTo(p[3].x, p[3].y);
      ctx.closePath();
      ctx.clip();

      // Transform matrix (approximation)
      ctx.transform(
        (p[1].x - p[0].x) / image.width,
        (p[1].y - p[0].y) / image.width,
        (p[3].x - p[0].x) / image.height,
        (p[3].y - p[0].y) / image.height,
        p[0].x,
        p[0].y
      );

      ctx.drawImage(image, 0, 0);
      ctx.restore();
    }
  </script>
</body>
</html>
